from pathlib import Path
import json
from datetime import datetime
import subprocess

class DojoContext:
    def __init__(self):
        self.cwd = Path.cwd()
        self.dojo_root = Path.home() / 'dojo'
        self.config_dir = Path.home() / '.config' / 'dojo'
        self.history_file = self.config_dir / 'history.json'
        self.config_file = self.config_dir / 'config.json'

        self.config_dir.mkdir(parents=True, exist_ok=True)
        if not self.history_file.exists():
            self.history_file.write_text(json.dumps({'recent': [], 'visits': {}, 'command_history': []}))
        if not self.config_file.exists():
            self.config_file.write_text(json.dumps({'learning_mode': False, 'version': 'v2'}))

        self.config = json.loads(self.config_file.read_text())
        self.project_name = self.get_project_name()

    def is_learning_mode(self):
        return self.config.get('learning_mode', False)

    def save_config(self, key, value):
        self.config[key] = value
        self.config_file.write_text(json.dumps(self.config, indent=2))

    def get_project_name(self):
        try:
            rel = self.cwd.relative_to(self.dojo_root)
            return str(rel)
        except:
            return None

    def log_command(self, cmd, args):
        """THIS WAS MISSING: Prevents the AttributeError"""
        try:
            data = json.loads(self.history_file.read_text())
            history = data.get('command_history', [])
            history.append({"ts": datetime.now().isoformat(), "cmd": cmd})
            data['command_history'] = history[-50:]
            self.history_file.write_text(json.dumps(data))
        except: pass

    def log_event(self, event_type, message):
        log_file = self.dojo_root / "knowledge" / "threads" / "activity_log.ndjson"
        log_file.parent.mkdir(parents=True, exist_ok=True)
        entry = {"ts": datetime.now().isoformat(), "proj": self.project_name, "type": event_type, "msg": message}
        with open(log_file, "a") as f:
            f.write(json.dumps(entry) + "\n")

    def generate_report(self):
        sys_path = self.dojo_root / 'system'
        report = [f"# DOJO REPORT | {datetime.now()}"]
        for f in ['IDENTITY.md', 'SYSTEM.md']:
            p = sys_path / f
            if p.exists(): report.append(f"## {f}\n{p.read_text()}")
        return "\n".join(report)

