#!/usr/bin/env python3
"""
Dojo CLI v2 - Your dev home
â›„ Simple, helpful, learns with you ðŸŒ¸
"""

import sys
from pathlib import Path

# Add lib to path
sys.path.insert(0, str(Path(__file__).parent / 'lib'))

from context import DojoContext
from ui import UI
from navigator import Navigator
from health import Health
from migrate import Migration

def main():
    ctx = DojoContext()
    ui = UI(ctx)
    nav = Navigator(ctx)
    health = Health(ctx)
    migrate = Migration(ctx, ui.console)  # Pass console
    
    # No arguments = interactive dashboard
    if len(sys.argv) == 1:
        ui.show_dashboard()
        return
    
    cmd = sys.argv[1]
    args = sys.argv[2:] if len(sys.argv) > 2 else []
    
    # Log command for history
    ctx.log_command(cmd, args)
    
    # Core commands
    if cmd in ['help', 'h', '--help']:
        ui.show_help()
    
    # Quick actions
    elif cmd == 'dev':
        nav.run_dev(args[0] if args else None)
    elif cmd == 'code':
        nav.open_vscode(args[0] if args else None)
    elif cmd == 'open':
        nav.open_explorer(args[0] if args else None)
    
    # Navigation
    elif cmd == 'goto':
        if not args:
            ui.console.print(" [error]Usage: dojo goto <name>[/]\n")
            return
        nav.goto(args[0])
    elif cmd == 'recent':
        nav.show_recent()
    elif cmd == 'ls':
        nav.list_projects(args[0] if args else None)
    elif cmd == 'where':
        nav.show_where()
    
    # Health & maintenance
    elif cmd == 'health':
        health.run_check()
    elif cmd == 'sync':
        health.sync_repos()
    elif cmd == 'clean':
        health.clean('--deep' in args)
    elif cmd == 'fix':
        if args and args[0] == 'all':
            ui.console.print("\n [accent]Running all fixes...[/]\n")
            health.run_check()  # This offers fixes
        elif args:
            ui.console.print(f" [error]Unknown fix target: {args[0]}[/]\n")
            ui.console.print(" [dim]Available: all, git, python[/]\n")
        else:
            ui.console.print(" [error]Usage: dojo fix <all|git|python>[/]\n")
    
    # Learning & config
    elif cmd == 'tutorial':
        ui.show_tutorial()
    elif cmd == 'examples':
        ui.show_examples()
    elif cmd == 'wizard':
        ui.show_wizard()
    elif cmd == 'learn':
        if args and args[0] in ['on', 'off']:
            enabled = args[0] == 'on'
            ctx.save_config('learning_mode', enabled)
            status = "enabled" if enabled else "disabled"
            ui.console.print(f"\n [success]Learning mode {status}![/]\n")
        else:
            current = "ON" if ctx.is_learning_mode() else "OFF"
            ui.console.print(f"\n Learning mode is currently: [accent]{current}[/]\n")
            ui.console.print(" [dim]Usage: dojo learn [on|off][/]\n")
    elif cmd == 'config':
        if args and args[0] == 'set' and len(args) >= 3:
            key, value = args[1], args[2]
            # Convert string boolean to actual boolean
            if value.lower() in ['true', 'false']:
                value = value.lower() == 'true'
            ctx.save_config(key, value)
            ui.console.print(f"\n [success]Set {key} = {value}[/]\n")
        else:
            ui.show_config()
    
    # Migration
    elif cmd == 'migrate':
        if '--preview' in args or (not args):
            migrate.preview()
            if not args:  # No flag = just preview
                ui.console.print(" [dim]Run 'dojo migrate --execute' to proceed[/]\n")
        elif '--execute' in args:
            migrate.execute()
        elif '--rollback' in args:
            migrate.rollback()
        else:
            ui.console.print(" [error]Usage: dojo migrate [--preview|--execute|--rollback][/]\n")
    
    # Smart shortcuts
    elif cmd == 'quick':
        # Quick command: auto-detect and run most common action
        if args:
            nav.goto(args[0])
        actions = ctx.get_quick_actions()
        if actions:
            nav.run_dev()
        else:
            ui.console.print(" [error]No quick action available here[/]\n")
    
    # Version info
    elif cmd in ['version', '--version', '-v']:
        ui.console.print("\n [accent]dojo v2.0[/] â›„ðŸŒ¸")
        ui.console.print(" Progressive, context-aware CLI")
        ui.console.print(f" [dim]Config: {ctx.config_dir}[/]\n")
    
    else:
        ui.console.print(f" [error]Unknown command: {cmd}[/]")
        ui.console.print(" [dim]Try 'dojo help' or just 'dojo' for interactive menu[/]\n")

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("\n")
        sys.exit(0)
    except Exception as e:
        print(f"\n [error]Error: {e}[/]")
        print(" [dim]Run 'dojo help' for usage information[/]\n")
        sys.exit(1)
