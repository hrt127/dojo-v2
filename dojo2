#!/usr/bin/env python3
"""
Dojo CLI v2 - Your dev home
‚õÑ Simple, helpful, learns with you üå∏
"""

import sys
from pathlib import Path

# Add lib to path
sys.path.insert(0, str(Path(__file__).parent / 'lib'))

from context import DojoContext
from ui import UI
from navigator import Navigator
from health import Health
from migrate import Migration

def main():
    ctx = DojoContext()
    ui = UI(ctx)
    nav = Navigator(ctx)
    health = Health(ctx)
    migrate = Migration(ctx, ui.console)  # Pass console

    # No arguments = interactive dashboard
    if len(sys.argv) == 1:
        ui.show_dashboard()
        return

    cmd = sys.argv[1]
    args = sys.argv[2:] if len(sys.argv) > 2 else []

    # Log command for history
    ctx.log_command(cmd, args)

    # Core commands
    if cmd in ['help', 'h', '--help']:
        ui.show_help()

    # --- DOJO OS CORE INTEGRATION ---
    
    elif cmd == 'handoff':
        # Powers the 'prime' ritual for AI context
        print(ctx.generate_report())

    elif cmd == 'log':
        # Manual event logging: dojo log "Finished panel 1"
        if args:
            ctx.log_event("USER_NOTE", " ".join(args))
            ui.console.print("\n [success]‚ùÑÔ∏è  Event logged to knowledge base.[/]\n")
        else:
            ui.console.print(" [error]Usage: dojo log <message>[/]\n")

    elif cmd == 'map':
        # Show structural tree
        import subprocess
        subprocess.run(['tree', str(ctx.dojo_root), '-L', '2', '--dirsfirst'])

    # --- EXISTING COMMANDS ---

    elif cmd == 'dev':
        nav.run_dev(args[0] if args else None)
    elif cmd == 'code':
        nav.open_vscode(args[0] if args else None)
    elif cmd == 'open':
        nav.open_explorer(args[0] if args else None)

    # Navigation
    elif cmd == 'goto':
        if not args:
            ui.console.print(" [error]Usage: dojo goto <name>[/]\n")
            return
        nav.goto(args[0])
    elif cmd == 'recent':
        nav.show_recent()
    elif cmd == 'ls':
        nav.list_projects(args[0] if args else None)
    elif cmd == 'where':
        nav.show_where()

    # Health & maintenance
    elif cmd == 'health':
        health.run_check()
    elif cmd == 'sync':
        health.sync_repos()
    elif cmd == 'clean':
        health.clean('--deep' in args)
    elif cmd == 'fix':
        if args and args[0] == 'all':
            ui.console.print("\n [accent]Running all fixes...[/]\n")
            health.run_check()
        else:
            ui.console.print(" [error]Usage: dojo fix <all>[/]\n")

    # Learning & config
    elif cmd == 'learn':
        if args and args[0] in ['on', 'off']:
            enabled = args[0] == 'on'
            ctx.save_config('learning_mode', enabled)
            status = "enabled" if enabled else "disabled"
            ui.console.print(f"\n [success]Learning mode {status}![/]\n")
        else:
            current = "ON" if ctx.is_learning_mode() else "OFF"
            ui.console.print(f"\n Learning mode is currently: [accent]{current}[/]\n")
    
    elif cmd == 'config':
        if args and args[0] == 'set' and len(args) >= 3:
            key, value = args[1], args[2]
            ctx.save_config(key, value)
            ui.console.print(f"\n [success]Set {key} = {value}[/]\n")
        else:
            ui.show_config()

    # Migration
    elif cmd == 'migrate':
        if '--execute' in args:
            migrate.execute()
        else:
            migrate.preview()

    # Version info
    elif cmd in ['version', '--version', '-v']:
        ui.console.print("\n [accent]dojo v2.0[/] ‚õÑüå∏")
        ui.console.print(f" [dim]Config: {ctx.config_dir}[/]\n")

    else:
        ui.console.print(f" [error]Unknown command: {cmd}[/]")

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        sys.exit(0)
    except Exception as e:
        print(f"\n [error]Error: {e}[/]")
        sys.exit(1)
